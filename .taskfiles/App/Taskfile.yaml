---
# yaml-language-server: $schema=https://raw.githubusercontent.com/go-task/task/main/docs/static/schema.json
version: '3'

tasks:
  create:
    desc: Create a new app in ./kubernetes/apps/{namespace}/{appname} (ex. task app:createa app=plex [ns=default])
    silent: true
    cmds:
      - |
        if [ -d "./kubernetes/apps/{{.ns}}/{{.app}}" ]; then
          echo "App already exists"
          exit 1
        fi
        mkdir -p ./kubernetes/apps/{{.ns}}/{{.app}}/app
        echo "---
        # yaml-language-server: \$schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
        apiVersion: kustomize.toolkit.fluxcd.io/v1
        kind: Kustomization
        metadata:
          name: cluster-apps-{{.app}}
          namespace: flux-system
        spec:
          path: ./kubernetes/apps/{{.ns}}/{{.app}}/app
          prune: true
          sourceRef:
            kind: GitRepository
            name: home-kubernetes
          wait: false
          interval: 30m
          retryInterval: 1m
          timeout: 5m
        " > ./kubernetes/apps/{{.ns}}/{{.app}}/ks.yaml
        echo "---
        # yaml-language-server: \$schema=https://json.schemastore.org/kustomization
        apiVersion: kustomize.config.k8s.io/v1beta1
        kind: Kustomization
        namespace: {{.ns}}
        resources:
          - ./helmrelease.yaml
        " > ./kubernetes/apps/{{.ns}}/{{.app}}/app/kustomization.yaml
        echo "---
        # yaml-language-server: \$schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta1.json
        apiVersion: helm.toolkit.fluxcd.io/v2beta1
        kind: HelmRelease
        metadata:
          name: {{.app}}
          namespace: {{.ns}}
        spec:
        " > ./kubernetes/apps/{{.ns}}/{{.app}}/app/helmrelease.yaml
    vars:
      app: '{{ or .app (fail "Appname `app` is required") }}'
      ns: '{{.ns | default "default"}}'

  archive:
    desc: Move the specified app to archive (ex. task app:archive app=plex [ns=default])
    silent: true
    cmds:
      - |
        if [ ! -d "./kubernetes/apps/{{.ns}}/{{.app}}" ]; then
          echo "App does not exist"
          exit 1
        fi
        mkdir -p ./archive/apps/{{.ns}}
        mv ./kubernetes/apps/{{.ns}}/{{.app}} ./archive/./kubernetes/apps/{{.ns}}/{{.app}}
        sed -i '/{{.app}}\/ks.yaml/d' ./kubernetes/apps/{{.ns}}/kustomization.yaml

    vars:
      app: '{{ or .app (fail "Appname `app` is required") }}'
      ns: '{{.ns | default "default"}}'
