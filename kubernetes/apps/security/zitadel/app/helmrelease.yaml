apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: zitadel
  namespace: security
spec:
  interval: 30m
  chart:
    spec:
      chart: zitadel
      version: 5.0.0
      sourceRef:
        kind: HelmRepository
        name: zitadel
        namespace: flux-system
  values:
    replicaCount: 3
    image:
      repository: ghcr.io/zitadel/zitadel
      tag: v2.30.0:sha256:97ba35342aba01622d9a1f80bc785ab6d22a41b502f4626e684e8e81add684e9
      pullPolicy: IfNotPresent
    zitadel:
      masterkey:
        valueFrom:
          secretKeyRef:
            name: zitadel-secret
            key: ZITADEL_MASTERKEY
      dbSslRootCrt: false
      dbSslRootCrtSecret: false
      dbSslClientCrtSecret: false
      configmapConfig:
        ExternalDomain: auth.${SECRET_DOMAIN}
        # specifies if ZITADEL is exposed externally through TLS
        # this must be set to true even if TLS is not enabled on ZITADEL itself
        # but TLS traffic is terminated on a reverse proxy
        # !!! Changing this after initial setup breaks your system !!!
        ExternalSecure: true
        TLS:
          # if enabled, ZITADEL will serve all traffic over TLS (HTTPS and gRPC)
          # you must then also provide a private key and certificate to be used for the connection
          # either directly or by a path to the corresponding file
          Enabled: false
        WebAuthNName: ZITADEL
        Database:
          # Postgres is used as soon as a value is set
          # The values describe the possible fields to set values
          postgres:
            User:
              Username:
                valueFrom:
                  secretKeyRef:
                    name: zitadel-secret
                    key: ZITADEL_DATABASE_POSTGRES_USER_USERNAME
              Password:
                valueFrom:
                  secretKeyRef:
                    name: zitadel-secret
                    key: ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
            Admin:
              Username:
                valueFrom:
                  secretKeyRef:
                    name: zitadel-secret
                    key: ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME
              Password:
                valueFrom:
                  secretKeyRef:
                    name: zitadel-secret
                    key: ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
    env:
      ZITADEL_DATABASE_POSTGRES_HOST: postgres-rw.database.svc.cluster.local
      ZITADEL_DATABASE_POSTGRES_PORT: "5432"
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
